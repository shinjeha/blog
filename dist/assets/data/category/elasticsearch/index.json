{"hash":"ccc1fdb6f2e137c3d58940c987b6e7692227e094","data":{"category":{"title":"elasticsearch","belongsTo":{"edges":[{"node":{"title":"_id wildcard 검색","path":"/post/2021-03-31-id-wildcard/","date":"31. March 2021","timeToRead":1,"excerpt":"<h1>_id wildcard로 검색</h1>\n<p>그냥 wildcard 쿼리로 검색하면 에러가 발생하므로 script를 이용한다.</p>\n<pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"query\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"script\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"script\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"doc['_id'][0].indexOf('test_') > -1\"</span>\n\t<span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>","category":{"id":"elasticsearch","title":"elasticsearch","path":"/category/elasticsearch/"},"tags":[]}},{"node":{"title":"AccessDeniedException error","path":"/post/2020-07-02-accessdeniedexception/","date":"2. July 2020","timeToRead":1,"excerpt":"<p>Elasticsearch 구동 시 에러가 발생했다.</p>\n<pre class=\"language-console\"><code class=\"language-console\">Exception in thread \"main\" java.nio.file.AccessDeniedException: /tmp/elasticsearch-~~~\n    at ...\n    at ...\n    at ...</code></pre>\n<p>말 그대로 권한 문제.</p><p>크게 두가지 경우로 나뉘는거 같다.</p>\n<h2>1. 파일 권한 문제</h2>\n<pre class=\"language-console\"><code class=\"language-console\">Exception in thread \"main\" java.nio.file.AccessDeniedException: /home/elasticsearch/config/jvm.options\n    at ...\n    at ...\n    at ...</code></pre>\n<p>구체적인 파일명이 적혀 있으면 해당 파일의 권한이 Elasticsearch권한으로 되어있는지 살펴봐야 한다. ...</p>","category":{"id":"elasticsearch","title":"elasticsearch","path":"/category/elasticsearch/"},"tags":[]}},{"node":{"title":"using regexp script in terms aggs","path":"/post/2020-04-27-terms-aggs-script/","date":"27. April 2020","timeToRead":1,"excerpt":"<p>데이터가 d_100, w_100 이런식으로 저장되어 있었는데,</p><p>d, w따로 나누어서 갯수를 집계해야 할 일이 생겼다.</p><p>어떻게 처리할까 생각하다가 정규식을 이용해서 분리했다.</p>\n<pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"size\"</span><span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"aggs\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"office\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"terms\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"field\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"office_field\"</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"aggs\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"danger\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token property\">\"terms\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">\"script\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"String aaa = /_/.split(doc.value_list[0])[0]; if (aaa == 'd') {doc['grp_nm'].value}\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"size\"</span><span class=\"token operator\">:</span> <span class=\"token number\">20</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"aggs\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"warning\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token property\">\"terms\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">\"script\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"String aaa = /_/.split(doc.value_list[0])[0]; if (aaa == 'w') {doc['grp_nm'].value}\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"size\"</span><span class=\"token operator\">:</span> <span class=\"token number\">20</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>","category":{"id":"elasticsearch","title":"elasticsearch","path":"/category/elasticsearch/"},"tags":[]}},{"node":{"title":"trim script","path":"/post/2020-04-27-trim-script/","date":"27. April 2020","timeToRead":1,"excerpt":"<p>keyword필드의 앞, 뒤 공백을 잘라야 할 일이 생겨서 쿼리를 작성해보았다.</p>\n<pre class=\"language-json\"><code class=\"language-json\">GET test_index/_update_by_query\n\n<span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"script\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"inline\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"ctx._source.str_field = ctx._source.str_field.trim();\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"lang\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"painless\"</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token string\">\"  문 자  열  \"</span>-> <span class=\"token string\">\"문 자  열\"</span></code></pre>","category":{"id":"elasticsearch","title":"elasticsearch","path":"/category/elasticsearch/"},"tags":[]}},{"node":{"title":"Too many dynamic script compilations within error","path":"/post/2019-06-13-too-many-dynamic-script-compilations-within/","date":"13. June 2019","timeToRead":1,"excerpt":"<h2>Too many dynamic script compilations within 에러</h2>\n<pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"error\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"root_cause\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"circuit_breaking_exception\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"reason\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"[script] Too many dynamic script compilations within, max: [75/5m]; please use indexed, or scripts with parameters instead; this limit can be changed by the [script.max_compilations_rate] setting\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"bytes_wanted\"</span><span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"bytes_limit\"</span><span class=\"token operator\">:</span> <span class=\"token number\">0</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">]</span>\n    ...\n  <span class=\"token property\">\"status\"</span><span class=\"token operator\">:</span> <span class=\"token number\">400</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>검색 결과 일정시간안에 너무 많은 스크립트가 발생해서 생기는 오류.</p><p>75/5m 으로 세팅되어 있는데 5분에 75개까지의 스크립트를 실행 할 수 있다는 의미.</p><p>공식문서를 찾아보니 스크립트를 사용할 떄 가급적 파라미터를 사용하기를 권장한다.</p>\n<ul>\n<li><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-scripting-using.html#prefer-params\">https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-scripting-using.html#prefer-params</a></li>\n</ul>\n<p>@TODO 스크립트 캐시 확인</p>","category":{"id":"elasticsearch","title":"elasticsearch","path":"/category/elasticsearch/"},"tags":[]}}]}}},"context":{}}